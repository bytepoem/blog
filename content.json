{"pages":[],"posts":[{"title":"åˆ©ç”¨ Grafana ä»¥åŠ node_exporter ä¸­çš„ tcpstat æ”¶é›†å™¨ç›‘æ§ TCP è¿æ¥å„ä¸ªçŠ¶æ€çš„æ•°é‡","text":"åœ¨ç»å†äº† CLOSE_WAIT å¢å¤šè€Œå¯¼è‡´çš„æœåŠ¡å™¨æ€§èƒ½ä¸‹é™çš„é—®é¢˜ä¹‹åï¼Œä¸ºäº†èƒ½å®æ—¶ç›‘æ§ TCP å„ä¸ªçŠ¶æ€çš„æ•°é‡ï¼Œæˆ‘é€‰æ‹©äº† Grafana ä»¥åŠ node_exporter çš„ tcpstat æ”¶é›†å™¨ã€‚ å…³äº node_exporter å°±ä¸å¤šåšä»‹ç»äº†ï¼Œæƒ³è¯¦ç»†äº†è§£çš„åŒå­¦å¯ä»¥è®¿é—® Github ä¸Šçš„ä»“åº“ ğŸ‘‰ Node exporter ã€‚ ç®€å•ä»‹ç»ä¸€ä¸‹ tcpstat æ”¶é›†å™¨ï¼Œæ˜¯ node_exporter è‡ªå¸¦çš„æ”¶é›†å™¨ï¼Œé€‚ç”¨çš„ç¯å¢ƒæ˜¯ Linuxï¼Œæœ¬è´¨æ˜¯ä» /proc/net/tcp ä»¥åŠ /proc/net/tcp6 è·å– TCP è¿æ¥çŠ¶æ€çš„ä¿¡æ¯ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å½“å‰ç‰ˆæœ¬ï¼ˆ0.18.1ï¼‰åœ¨é«˜è´Ÿè½½ä¸‹ä¼šå‡ºç°æ€§èƒ½é—®é¢˜ï¼Œå…·ä½“è¡¨ç°å°±æ˜¯é‡‡é›†åœ°å€æ— æ³•è®¿é—®å¯¼è‡´ Prometheus æ— æ³•è·å–æ•°æ®ã€‚å¦å¤–ï¼Œtcpstat æ”¶é›†å™¨æ˜¯é»˜è®¤ä¸å¼€å¯ï¼Œæ‰€ä»¥å¯åŠ¨çš„æ—¶å€™éœ€è¦å¸¦ä¸Š --collector.tcpstat å‚æ•°ï¼ˆå¯ä»¥é€šè¿‡å‚æ•° -h äº†è§£ï¼‰ã€‚ å¯åŠ¨å¥½ node_exporter å¹¶å¼€å¯ tcpstat æ”¶é›†å™¨ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å‰å¾€ Grafana è®¾ç½®ç›‘æ§é¢æ¿äº†ã€‚ åœ¨æ–°å»º panel ä¸­æ·»åŠ ä¸€ä¸ª Queryï¼ŒæŸ¥è¯¢è¯­å¥ï¼šnode_tcp_connection_states{instance=&quot;localhost:9100&quot; å…¶ä¸­ node_tcp_connection_states æ˜¯ TCP è¿æ¥çŠ¶æ€çš„ metric çš„åç§°ï¼Œè¿™ä¸ªæ€ä¹ˆæ¥çš„å‘¢ï¼Œæˆ‘æ˜¯çè’™çš„ï¼Œå› ä¸º Grafana è‡ªå¸¦è¯­æ³•æç¤ºï¼Œæ‰€ä»¥è¾“å…¥ tcp å°±å¯ä»¥ç›´æ¥æ‰¾åˆ°ï¼ˆï¼‰ã€‚è€Œ 9100 å°±æ˜¯ node_exporter çš„é»˜è®¤ç«¯å£å·ã€‚ å®Œæ•´çš„ Query å°±æ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­ã€‚ æœ€åæŸ¥è¯¢å‡ºæ¥çš„æ•ˆæœå¦‚ä¸‹ï¼š tcpstat æ”¶é›†å™¨ç›¸å…³çš„å®ç°åœ¨è¿™é‡Œ ğŸ‘‰ tcpstat_linux.go ã€‚ä¸‹é¢è´´ä¸€ä¸‹ä¸»è¦ä»£ç ç‰‡æ®µã€‚ é¦–å…ˆ tcpstat å®šä¹‰äº† TCP è¿æ¥å„ä¸ªçŠ¶æ€çš„å¸¸é‡ï¼Œå³æˆ‘ä»¬å¯ä»¥æ”¶é›†ï¼ˆç›‘æ§ï¼‰åˆ°çš„ä¿¡æ¯ã€‚ 12345678910111213141516171819202122232425262728const ( // TCP_ESTABLISHED tcpEstablished tcpConnectionState = iota + 1 // TCP_SYN_SENT tcpSynSent // TCP_SYN_RECV tcpSynRecv // TCP_FIN_WAIT1 tcpFinWait1 // TCP_FIN_WAIT2 tcpFinWait2 // TCP_TIME_WAIT tcpTimeWait // TCP_CLOSE tcpClose // TCP_CLOSE_WAIT tcpCloseWait // TCP_LAST_ACK tcpLastAck // TCP_LISTEN tcpListen // TCP_CLOSING tcpClosing // TCP_RX_BUFFER tcpRxQueuedBytes // TCP_TX_BUFFER tcpTxQueuedBytes) æ¥ç€å®šä¹‰äº†æ”¶é›†å™¨çš„ç›¸å…³ä¿¡æ¯ï¼Œæ¯”å¦‚ä¸Šè¾¹æåˆ°çš„ metric çš„åç§° node_tcp_connection_states ä»¥åŠæä¾›çš„æ¨¡æ¿å˜é‡ stateã€‚ 12345678910func NewTCPStatCollector(logger log.Logger) (Collector, error) { return &amp;tcpStatCollector{ desc: typedDesc{prometheus.NewDesc( prometheus.BuildFQName(namespace, \"tcp\", \"connection_states\"), \"Number of connection states.\", []string{\"state\"}, nil, ), prometheus.GaugeValue}, logger: logger, }, nil} ä¸‹é¢ä¸¤ä¸ªæ–¹æ³•å°±æ˜¯ä» /proc/net/tcp ä»¥åŠ /proc/net/tcp6 è¿™ä¸¤ä¸ªæ–‡ä»¶è·å– TCP è¿æ¥çŠ¶æ€çš„ä¿¡æ¯å¹¶è½¬åŒ–ä¸º metricã€‚ 12345678910111213141516171819202122232425262728293031323334func (c *tcpStatCollector) Update(ch chan&lt;- prometheus.Metric) error { tcpStats, err := getTCPStats(procFilePath(\"net/tcp\")) if err != nil { return fmt.Errorf(\"couldn't get tcpstats: %s\", err) } // if enabled ipv6 system tcp6File := procFilePath(\"net/tcp6\") if _, hasIPv6 := os.Stat(tcp6File); hasIPv6 == nil { tcp6Stats, err := getTCPStats(tcp6File) if err != nil { return fmt.Errorf(\"couldn't get tcp6stats: %s\", err) } for st, value := range tcp6Stats { tcpStats[st] += value } } for st, value := range tcpStats { ch &lt;- c.desc.mustNewConstMetric(value, st.String()) } return nil}func getTCPStats(statsFile string) (map[tcpConnectionState]float64, error) { file, err := os.Open(statsFile) if err != nil { return nil, err } defer file.Close() return parseTCPStats(file)} æœ¬æ–‡åˆ°è¿™é‡Œç»“æŸå•¦ï¼Œä¸»è¦ä»‹ç»äº†å¦‚ä½•åˆ©ç”¨ Grafana + node_exporter.tcpstat çš„æ–¹å¼å®æ—¶ç›‘æ§ TCP è¿æ¥çŠ¶æ€ä¿¡æ¯ï¼Œå¦‚æœå¤§å®¶æœ‰å…¶ä»–çš„æ–¹å¼ï¼Œæ¬¢è¿ä¸‹æ–¹ç•™è¨€è®¨è®ºã€‚","link":"/2020/04/21/grafana-tcp-status/"},{"title":"åœ¨ Spring Boot ä¸­ä½¿ç”¨ @Crossorign æ³¨è§£è§£å†³è·¨åŸŸé—®é¢˜","text":"æœ€è¿‘åœ¨ Spring Boot ä¸­å†™ REST API æ—¶å‘ç°å‰ç«¯ Ajax è°ƒç”¨çš„æ—¶å€™ä¼šäº§ç”Ÿè·¨åŸŸé—®é¢˜ã€‚äºæ˜¯ä¹æƒ³åˆ°ç”¨ jsonp çš„æ–¹å¼è¿›è¡Œè§£å†³ï¼Œä½†æ˜¯å‘ç° AbstractJsonpResponseBodyAdvice è¿™ä¸ªç±»åœ¨ Spring Boot 2.0 å·²ç»è¢«åºŸå¼ƒäº†ï¼Œä¸Šå®˜ç½‘å‘ç°æœ‰æ–°å§¿åŠ¿â€”â€”ã€ŠEnabling Cross Origin Requests for a RESTful Web Serviceã€‹ã€‚ 1. æµè§ˆå™¨çš„åŒæºæ”¿ç­–åŒæºç­–ç•¥ï¼ˆSOPï¼ŒSame origin policyï¼‰ æ˜¯ç”± Netscape æå‡ºçš„ä¸€ä¸ªè‘—åçš„å®‰å…¨ç­–ç•¥ã€‚æ‰€æœ‰æ”¯æŒ JavaScript çš„æµè§ˆå™¨éƒ½ä¼šä½¿ç”¨è¿™ä¸ªç­–ç•¥ã€‚æ‰€è°“åŒæºæ˜¯æŒ‡ï¼ŒåŸŸåï¼Œåè®®ï¼Œç«¯å£ç›¸åŒã€‚å³ä¾¿ä¸¤ä¸ªä¸åŒçš„åŸŸåæŒ‡å‘åŒä¸€ä¸ª ip åœ°å€ï¼Œä¹ŸéåŒæºã€‚ åŒæºç­–ç•¥é™åˆ¶ä»¥ä¸‹å‡ ç§è¡Œä¸ºï¼š 1ã€Cookieã€LocalStorage å’Œ IndexDB æ— æ³•è¯»å– 2ã€Dom å’Œ Js å¯¹è±¡æ— æ³•è·å¾— 3ã€Ajax è¯·æ±‚ä¸èƒ½å‘é€ å…¶ç›®çš„æ˜¯ä¸ºäº†ä¿è¯ç”¨æˆ·ä¿¡æ¯çš„å®‰å…¨ï¼Œé˜²æ­¢æ¶æ„çš„ç½‘ç«™çªƒå–æ•°æ®ã€‚ä¸¾ä¸ªä¾‹å­ï¼š A ç½‘ç«™æ˜¯ä¸€å®¶é“¶è¡Œï¼Œç”¨æˆ·ç™»å½•ä»¥åå†å»è®¿é—® B ç½‘ç«™ã€‚å¦‚æœ B ç½‘ç«™å¯ä»¥è¯»å– A ç½‘ç«™çš„ Cookieï¼Œé‚£ä¹ˆ B ç½‘ç«™å°±å¯ä»¥åˆ©ç”¨è¿™äº›ä¿¡æ¯ä¸ºæ‰€æ¬²ä¸ºï¼ï¼ˆæµè§ˆå™¨æäº¤è¡¨å•ä¸å—åŒæºæ”¿ç­–çš„é™åˆ¶ï¼‰ã€‚ 2. è·¨åŸŸè§£å†³æ–¹æ¡ˆ 1ã€jsonpï¼ˆåªæ”¯æŒ GET è¯·æ±‚ï¼‰ 2ã€document.domain + iframe 3ã€location.hash + iframe 4ã€window.name + iframe 5ã€postMessage 6ã€è·¨åŸŸèµ„æºå…±äº«ï¼ˆCORSï¼‰ 7ã€nginx ä»£ç† 8ã€nodejs ä¸­é—´ä»¶ä»£ç†è·¨åŸŸ 9ã€WebSocket åè®®è·¨åŸŸ 3. CORSCORS æ˜¯ä¸€ä¸ª W3C æ ‡å‡†ï¼Œå…¨ç§°æ˜¯ â€œè·¨åŸŸèµ„æºå…±äº«â€ï¼ˆCross-origin resource sharingï¼‰ï¼Œæ˜¯ä¸€ç§å…è®¸å½“å‰åŸŸï¼ˆdomainï¼‰çš„èµ„æºï¼ˆæ¯”å¦‚ html / js / web serviceï¼‰è¢«å…¶ä»–åŸŸï¼ˆdomainï¼‰çš„è„šæœ¬è¯·æ±‚è®¿é—®çš„æœºåˆ¶ï¼ˆåˆ©ç”¨ XMLHttpRequest è¯·æ±‚ï¼‰ã€‚ç”±äºåŒæºç­–ç•¥ï¼Œæµè§ˆå™¨é€šå¸¸ä¼šç¦æ­¢è¿™ç§è·¨åŸŸè¯·æ±‚ã€‚ CORS è¯·æ±‚åˆ†ä¸ºä¸¤ç±»ï¼šç®€å•è¯·æ±‚å’Œéç®€å•è¯·æ±‚ã€‚ å…¶ä¸­æ»¡è¶³ä»¥ä¸‹ä¸¤å¤§æ¡ä»¶ï¼Œå°±å±äºç®€å•è¯·æ±‚ã€‚ è¯·æ±‚æ–¹æ³•æ˜¯ä»¥ä¸‹ä¸‰ç§æ–¹æ³•ä¹‹ä¸€ï¼š HEAD GET POST HTTP çš„å¤´ä¿¡æ¯ä¸è¶…å‡ºä»¥ä¸‹å‡ ç§å­—æ®µï¼š AcceptAccept-Language Content-Language Last-Event-ID Content-Typeï¼šåªé™äºä»¥ä¸‹ä¸‰ä¸ªå€¼ application/x-www-form-urlencoded multipart/form-data text/plain ä¸æ»¡è¶³çš„ä¸ºéç®€å•è¯·æ±‚ã€‚ æµè§ˆå™¨å¯¹äºä¸¤ç§è¯·æ±‚çš„å¤„ç†æ˜¯ä¸ä¸€æ ·çš„ï¼š ç®€å•è¯·æ±‚ æµè§ˆå™¨ä¼šåœ¨ç®€å•è¯·æ±‚çš„è¯·æ±‚å¤´ä¸­æ·»åŠ  Origin å­—æ®µï¼Œç”¨æ¥è¯´æ˜æœ¬æ¬¡è¯·æ±‚æ¥è‡ªå“ªä¸ªæºï¼ˆåè®® + åŸŸå + ç«¯å£ï¼‰ã€‚æœåŠ¡å™¨åˆ¤æ–­è¿™ä¸ªå€¼å†³å®šæ˜¯å¦é€šè¿‡è¿™æ¬¡è¯·æ±‚ ä¸é€šè¿‡æ—¶ï¼Œè¿”å›å¤´åˆ™æ²¡æœ‰ Access-Control-Allow-Origin å­—æ®µ é€šè¿‡æ—¶ï¼Œåˆ™ä¼šå¤šå‡ºä»¥ä¸‹å‡ ä¸ªå­—æ®µ 123Access-Control-Allow-Origin: http://api.baidu.comAccess-Control-Allow-Credentials: true Access-Control-Expose-Headers: FooBarContent-Type: text/html; charset=utf-8 éç®€å•è¯·æ±‚ åœ¨æ­£å¼è¯·æ±‚å‰ä¼šå‘é€ä¸€ä¸ªé¢„æ£€è¯·æ±‚ï¼ˆOPTIONSï¼‰ 123OPTIONS /cors HTTP/1.1 Origin: http://api.bob.comAccess-Control-Request-Method:PUT Access-Control-Request-Headers: X-Custom-Header Host: api.baidu.comAccept-Language: en-US Connection: keep-alive User-Agent: Mozilla/5.0... ä¸€æ—¦æœåŠ¡å™¨é€šè¿‡äº†é¢„æ£€è¯·æ±‚ï¼Œä»¥åæ¯æ¬¡æµè§ˆå™¨æ­£å¸¸çš„ CORS è¯·æ±‚ï¼Œå°±éƒ½è·Ÿç®€å•è¯·æ±‚ä¸€æ ·ï¼Œè¿”å›å¤´ä¼šå¤šä¸€ä¸ª Origin å­—æ®µä»¥åŠ Access-Control-Allow-Origin å­—æ®µã€‚ 4.@Crossorigin æ³¨è§£å…¨å±€é…ç½®12345678910111213141516171819202122import org.springframework.context.annotation.Configuration;import org.springframework.web.servlet.config.annotation.CorsRegistry;import org.springframework.web.servlet.config.annotation.EnableWebMvc;import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;@Configuration@EnableWebMvcpublic class CorsConfig implements WebMvcConfigurer { @Override public void addCorsMappings(CorsRegistry registry) { //è®¾ç½®å…è®¸è·¨åŸŸçš„è·¯å¾„ registry.addMapping(\"/**\") //è®¾ç½®å…è®¸è·¨åŸŸè¯·æ±‚çš„åŸŸå .allowedOrigins(\"*\") //æ˜¯å¦å…è®¸è¯ä¹¦ ä¸å†é»˜è®¤å¼€å¯ .allowCredentials(true) //è®¾ç½®å…è®¸çš„æ–¹æ³• .allowedMethods(\"*\") //è·¨åŸŸå…è®¸æ—¶é—´ .maxAge(3600); } å±€éƒ¨é…ç½®å¯ä»¥æ³¨è§£åœ¨æ•´ä¸ª Controller ä¸Šã€‚ 123@CrossOrigin(origins=\"http://localhost:9000\", maxAge=3600)@RestControllerpublic class RestController {} ä¹Ÿå¯ä»¥æ³¨è§£åœ¨å•ä¸ªæ–¹æ³•ä¸Šã€‚ 12345@CrossOrigin(origins=\"http://localhost:9000\")@GetMapping(\"/hello\")public Greeting greeting() { return \"world\";} è¿˜å¯ä»¥é€šè¿‡ Filter çš„æ–¹å¼æŒ‡å®šæ¥å£ã€‚ 1234567891011121314@Beanpublic FilterRegistrationBean corsFilter() { UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource(); CorsConfiguration config = new CorsConfiguration(); config.setAllowCredentials(true); config.addAllowedOrigin(\"http://localhost:9000\"); config.addAllowedOrigin(\"null\"); config.addAllowedHeader(\"*\"); config.addAllowedMethod(\"*\"); source.registerCorsConfiguration(\"/**\", config); // CORS é…ç½®å¯¹æ‰€æœ‰æ¥å£éƒ½æœ‰æ•ˆ FilterRegistrationBean bean = newFilterRegistrationBean(new CorsFilter(source)); bean.setOrder(0); return bean;} 5. æµ‹è¯•æ–°å»ºå¦å¤–ä¸€ä¸ª web é¡¹ç›®ï¼Œæ­¤é¡¹ç›®ç«¯å£ä¸º 9000ï¼Œå³æˆ‘ä»¬å‰é¢è®¾ç½®çš„ origin ï¼Œè€Œ api é¡¹ç›®çš„ç«¯å£ä¸º 8080ã€‚ å…¶ä¸­ä¸»è¦ä»£ç å¦‚ä¸‹ï¼š public/hello.js 12345678$(document).ready(function () { $.ajax({ url: \"http://localhost:8080/hello\", }).then(function (data, status, jqxhr) { $(\".greeting-test\").append(data); console.log(jqxhr); });}); public/index.html 1234567891011121314&lt;!DOCTYPE html&gt;&lt;html&gt; &lt;head&gt; &lt;title&gt;Hello CORS&lt;/title&gt; &lt;script src=\"https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js\"&gt;&lt;/script&gt; &lt;script src=\"hello.js\"&gt;&lt;/script&gt; &lt;/head&gt; &lt;body&gt; &lt;div&gt; &lt;p class=\"greeting-test\"&gt;Hello&lt;/p&gt; &lt;/div&gt; &lt;/body&gt;&lt;/html&gt; è¯·æ±‚æˆåŠŸæ—¶å³å¯çœ‹åˆ°è¿”å›ç»“æœã€‚ 1Hello world å‚è€ƒé“¾æ¥ï¼š è·¨åŸŸèµ„æºå…±äº« CORS è¯¦è§£ â€”â€” é˜®ä¸€å³° ã€ŠEnabling Cross Origin Requests for a RESTful Web Serviceã€‹","link":"/2020/04/11/spring-boot-crossorign/"},{"title":"è®°å½•ä¸€æ¬¡æœåŠ¡å™¨å‡ºç°å¤§é‡ CLOSE_WAIT çš„åŸå› æ’æŸ¥è¿‡ç¨‹ä»¥åŠè§£å†³åŠæ³•","text":"æœ€è¿‘åœ¨æœåŠ¡å™¨ä¸Šå‘ç°æœ‰å¤§é‡çš„ CLOSE_WAIT å­˜åœ¨ï¼Œæ’æŸ¥å‘ç°æ˜¯ Python çˆ¬è™«ä¸­ requests å¯¼è‡´çš„ã€‚ 1. CLOSE WAITç®€å•æ¥è¯´ï¼ŒTCP è¿æ¥æ–­å¼€æ—¶éœ€è¦è¿›è¡Œâ€œå››æ¬¡æŒ¥æ‰‹â€ï¼ˆå»ºç«‹è¿æ¥æ˜¯â€œä¸‰æ¬¡æ¡æ‰‹â€ï¼‰ï¼ŒTCP è¿æ¥çš„ä¸¤ç«¯éƒ½å¯ä»¥å‘èµ·å…³é—­è¿æ¥çš„è¯·æ±‚ï¼Œè‹¥å…¶ä¸­ä¸€ç«¯å‘èµ·äº†å…³é—­è¿æ¥ï¼Œä½†å¦å¤–ä¸€ç«¯æ²¡æœ‰å…³é—­è¿æ¥ï¼Œé‚£ä¹ˆè¯¥è¿æ¥å°±ä¼šå¤„äº CLOSE_WAIT çŠ¶æ€ã€‚ å››æ¬¡æ¡æ‰‹çš„æµç¨‹ï¼š Client å‘é€ä¸€ä¸ª FINï¼Œç”¨æ¥å…³é—­å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨çš„æ•°æ®ä¼ é€ï¼ˆæŠ¥æ–‡æ®µ 1ï¼‰ Server æ”¶åˆ°è¿™ä¸ª FINï¼Œå‘å›ä¸€ä¸ª ACKï¼Œç¡®è®¤éœ€è¦ä¸ºæ”¶åˆ°çš„åºå·åŠ  1ï¼ˆæŠ¥æ–‡æ®µ 5ï¼‰ã€‚å’Œ SYN ä¸€æ ·ï¼Œä¸€ä¸ª FIN å ç”¨ä¸€ä¸ªåºå· Server å…³é—­ Client çš„è¿æ¥ï¼Œå‘é€ä¸€ä¸ª FIN ç»™å®¢æˆ·ç«¯ï¼ˆæŠ¥æ–‡æ®µ 6ï¼‰ Client å‘å› ACK æŠ¥æ–‡ç¡®è®¤ï¼Œå¹¶å°†ç¡®è®¤åºå·è®¾ä¸ºæ”¶åˆ°çš„åºå·åŠ  1ï¼ˆæŠ¥æ–‡æ®µ 4ï¼‰ 2. åŸå› é€šå¸¸æ¥è¯´ï¼ŒCLOSE_WAIT åœ¨æœåŠ¡å™¨åœç•™çš„æ—¶é—´å¾ˆçŸ­ï¼Œä¸”åªä¼šå‘ç”Ÿåœ¨è¢«åŠ¨å…³é—­è¿æ¥çš„ä¸€ç«¯ã€‚é™¤é Kill æ‰è¿›ç¨‹ï¼Œå¦åˆ™å®ƒæ˜¯ä¸ä¼šæ¶ˆå¤±çš„ï¼Œæ„å‘³ç€ä¸€ç›´å ç”¨èµ„æºã€‚å¦‚æœå‘ç°æœ‰å¤§é‡çš„ CLOSE_WAITï¼Œé‚£å°±æ˜¯è¢«åŠ¨å…³é—­çš„ä¸€æ–¹æ²¡æœ‰åŠæ—¶å‘é€ FINï¼Œä¸€èˆ¬æ¥è¯´æœ‰ä»¥ä¸‹å‡ ç§å¯èƒ½ï¼š ä»£ç é—®é¢˜ï¼šè¯·æ±‚çš„æ—¶å€™æ²¡æœ‰æ˜¾å¼å…³é—­ Socket è¿æ¥ï¼Œæˆ–è€…æ­»å¾ªç¯å¯¼è‡´å…³é—­è¿æ¥çš„ä»£ç æ²¡æœ‰æ‰§è¡Œåˆ°ï¼Œå³ FIN åŒ…æ²¡æœ‰å‘å‡ºï¼Œå¯¼è‡´ CLOSE_WAIT ä¸æ–­ç´¯ç§¯ å“åº”è¿‡æ…¢ / è¶…æ—¶è®¾ç½®è¿‡å°ï¼šåŒæ–¹è¿æ¥ä¸ç¨³å®šï¼Œä¸€æ–¹ Timeoutï¼Œå¦å¤–ä¸€æ–¹è¿˜åœ¨å¤„ç†é€»è¾‘ï¼Œå¯¼è‡´ Close è¢«å»¶å 3. æ’æŸ¥æŸ¥çœ‹ç½‘ç»œè¿æ¥é¦–å…ˆæˆ‘ä»¬åˆ°æœåŠ¡å™¨ä¸Šçœ‹ä¸€ä¸‹ç½‘ç»œè¿æ¥æƒ…å†µã€‚ æŸ¥çœ‹ TCP è¿æ¥ä¸­å„ä¸ªçŠ¶æ€æ•°é‡å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š netstat -n | awk '/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}' ESTABLISHED è¡¨ç¤ºæ­£åœ¨é€šä¿¡ TIME_WAIT è¡¨ç¤ºä¸»åŠ¨å…³é—­ CLOSE_WAIT è¡¨ç¤ºè¢«åŠ¨å…³é—­ æŸ¥çœ‹ TCP è¿æ¥ä¸­ CLOSE_WAIT çš„æ•°é‡å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š netstat -antop | grep CLOSE_WAIT | wc -l netstat å‘½ä»¤ç”¨äºæ˜¾ç¤ºç½‘ç»œçŠ¶æ€ -aï¼šæ˜¾ç¤ºæ‰€æœ‰è¿çº¿ä¸­çš„ Socket -nï¼šç›´æ¥ä½¿ç”¨ IP åœ°å€ï¼Œè€Œä¸é€šè¿‡åŸŸåæœåŠ¡å™¨ -tï¼šæ˜¾ç¤º TCP ä¼ è¾“åè®®çš„è¿çº¿çŠ¶å†µ -oï¼šæ˜¾ç¤ºè®¡æ—¶å™¨ -pï¼šæ˜¾ç¤ºæ­£åœ¨ä½¿ç”¨ Socket çš„ç¨‹åºè¯†åˆ«ç å’Œç¨‹åºåç§° grep å‘½ä»¤ç”¨äºæŸ¥æ‰¾æ–‡ä»¶é‡Œç¬¦åˆæ¡ä»¶çš„å­—ç¬¦ä¸² wc å‘½ä»¤ç”¨äºè®¡ç®—å­—æ•° -lï¼šåªæ˜¾ç¤ºè¡Œæ•° é€šè¿‡ä»¥ä¸Šå‘½ä»¤å¯ä»¥çœ‹åˆ°æœåŠ¡å™¨ä¸Šçš„ CLOSE_WAIT å°†è¿‘ 1w2ï¼Œè¿™è¿˜æ˜¯æˆ‘é‡å¯äº†éƒ¨åˆ†è¿è¡Œæ—¶é—´è¾ƒé•¿çš„çˆ¬è™«åçš„æ•°å­—ï¼Œé‡å¯å‰é«˜è¾¾ 4wï¼Œè¿™æ˜¯ä¸ªä¸å®¹å°è§‘çš„æ½œåœ¨é—®é¢˜ã€‚ æ¢³ç† TCP è¿æ¥æµå‘æ¥ç€æˆ‘ä»¬å¯ä»¥ä»ä¸Šå›¾æ¢³ç†å‡º CLOSE_WAIT çš„è¿æ¥æµå‘ï¼Œå‘½ä»¤è¿”å›é‡Œä¸­çš„ Foreign Addressï¼ˆç¬¬ 5 æ ï¼‰ä»£è¡¨å¯¹æ–¹çš„ IP åœ°å€ï¼Œå³å’Œæˆ‘ä»¬è¿æ¥ç€ä½†æ˜¯å´ä¸»åŠ¨å…³é—­äº†è¿æ¥çš„æœºå™¨ï¼Œåœ¨æˆ‘è¿™é‡Œå³æ˜¯ä»£ç†æ± é‡Œè¾¹çš„ä»£ç†ã€‚ æ ¹æ®é¡¹ç›®æ•°æ®è¯·æ±‚æµå‘è¿˜åŸå¯èƒ½åœºæ™¯ç„¶åæˆ‘ä»¬å¯ä»¥æ ¹æ®é¡¹ç›®æ•°æ®è¯·æ±‚æµå‘ï¼Œè¿˜åŸå‡ºå¯èƒ½çš„åœºæ™¯ï¼Œåœ¨æˆ‘è¿™é‡Œå³æ˜¯ CLOSE_WAIT éƒ½å‘ç”Ÿåœ¨æœ¬æœºçˆ¬è™«ã€ä»£ç†ä»¥åŠç›®æ ‡ç½‘ç«™çš„è¿æ¥ä¸Šã€‚æ¯•ç«Ÿ Program nameï¼ˆæœ€åä¸€æ ï¼‰éƒ½å†™ç€ Python äº†ï¼Œä¸”è¿™å°æœåŠ¡å™¨ä¸Šåªæœ‰çˆ¬è™«ç”¨çš„ Pythonã€‚ è§£å†³æ€è·¯é—®é¢˜å‡ºåœ¨çˆ¬è™«å°±ç®€å•äº†ï¼Œå”¯ä¸€ä¼šå‘ç”Ÿç½‘ç»œè¯·æ±‚çš„åœ°æ–¹å°±æ˜¯ä½¿ç”¨ requests æ¨¡å—ã€‚ requests æ¨¡å—ä¼šè‡ªè¡Œå¤„ç†è¿æ¥æ± çš„é—®é¢˜ï¼Œä¸”è®¿é—®å®Œæˆåå‡ºç° CLOSE_WAIT æ˜¯æ­£å¸¸çš„ï¼Œåç»­ä¼šç›´æ¥å¤ç”¨è¿™äº›è¿æ¥ã€‚ä½†æ˜¯å¦‚æœ CLOSE_WAIT æ•°é‡å¤ªå¤šä¸”ä¸€ç›´ä¸‹ä¸å»ï¼Œæœ‰å¯èƒ½æ˜¯é«˜å¹¶å‘æˆ–è€…æ²¡æœ‰å…³é—­çš„è¿æ¥ä¸€ç›´ç´¯ç§¯ å¦‚æœä½ ç›´æ¥ get æˆ–è€… post çš„è¯ä¼šæ¯æ¬¡éƒ½åˆ›å»ºä¸€ä¸ªè¿æ¥æ± ï¼Œä¸”è¿™ä¸ªè¿æ¥æ± åªä¼šç”¨ä¸€æ¬¡ã€‚æ‰€ä»¥éœ€è¦é€šè¿‡å…¨å±€ session æ¥ä½¿ç”¨ requests æ¨¡å—çš„è¿æ¥æ± åŠŸèƒ½ ä¸æ˜¯ä»»ä½•æ—¶å€™ä½¿ç”¨è¿æ¥æ± éƒ½æ˜¯æœ‰æ•ˆçš„ï¼Œä»…å½“ä½ ä½¿ç”¨äº†å¤šçº¿ç¨‹ä¹‹ç±»çš„å¹¶å‘æ‰ä¼šæœ‰æ•ˆæœã€‚æ¯•ç«Ÿä½ æ˜¯å•çº¿ç¨‹çš„è¯ï¼Œé‡Œé¢æ˜¯ä¸²è¡Œï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªè¿æ¥ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ„é€ å¥½ HttpAdapter å®ä¾‹ç”¨ session.mount ä¸Šã€‚HttpAdapter çš„å¸¸ç”¨å‚æ•°æœ‰ä»¥ä¸‹å‡ ç§ï¼š timeoutï¼šè¶…æ—¶æ—¶é—´ maxretriesï¼šæœ€å¤§å°è¯•æ¬¡æ•° pool_connectionsï¼šæœ€å¤šè¿æ¥å¤šå°‘ä¸ªä¸åŒçš„ä¸»æœºï¼Œé’ˆå¯¹æ¯ä¸ª Host éƒ½æ˜¯ç‹¬ç«‹çš„è¿æ¥æ±  pool_maxsizeï¼šé’ˆå¯¹æ¯ä¸ªä¸»æœºèƒ½åˆ›å»ºçš„æœ€å¤§è¿æ¥æ•°ï¼ˆåº•å±‚ TCPï¼‰ï¼Œç”±äºä¸€ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªè¿æ¥ï¼Œæ‰€ä»¥ä¸€èˆ¬æœ‰å¤šå°‘ä¸ªçº¿ç¨‹æŒ‡å®š pool_maxsize ä¸ºå¤šå°‘ ä½¿ç”¨ requests æ¨¡å—çš„æ—¶å€™æœ€å¥½å°†è¯·æ±‚æ”¾åœ¨ try ä¸­ï¼ŒæŠŠå¯èƒ½å‘ç”Ÿçš„å¼‚å¸¸ç”¨ except è·å–å¹¶å¤„ç† å‚è€ƒé“¾æ¥ï¼š æµ…è°ˆ CLOSE_WAIT åˆè§ CLOSE_WAIT ã€åŸåˆ›ã€‘python requests åº“åº•å±‚ Sockets å¤„äº close_wait çŠ¶æ€","link":"/2020/04/20/to-many-close-wait/"}],"tags":[{"name":"grafana","slug":"grafana","link":"/tags/grafana/"},{"name":"node_exporter","slug":"node-exporter","link":"/tags/node-exporter/"},{"name":"tcp","slug":"tcp","link":"/tags/tcp/"},{"name":"spring boot","slug":"spring-boot","link":"/tags/spring-boot/"},{"name":"java","slug":"java","link":"/tags/java/"},{"name":"linux","slug":"linux","link":"/tags/linux/"},{"name":"python","slug":"python","link":"/tags/python/"}],"categories":[{"name":"grafana","slug":"grafana","link":"/categories/grafana/"},{"name":"spring boot","slug":"spring-boot","link":"/categories/spring-boot/"},{"name":"linux","slug":"linux","link":"/categories/linux/"}]}